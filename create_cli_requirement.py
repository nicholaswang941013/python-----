#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
CLI å·¥å…·é–‹ç™¼éœ€æ±‚å–®å‰µå»ºè…³æœ¬

æ­¤è…³æœ¬å°‡ CLI å·¥å…·é–‹ç™¼éœ€æ±‚å–®ç›´æ¥å¯«å…¥éœ€æ±‚ç®¡ç†ç³»çµ±çš„è³‡æ–™åº«ä¸­ã€‚
"""

import sys
import os
from datetime import datetime, timedelta

# æ·»åŠ ç•¶å‰ç›®éŒ„åˆ° Python è·¯å¾‘ï¼Œä»¥ä¾¿å°å…¥å°ˆæ¡ˆæ¨¡çµ„
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from database import create_connection, create_requirement, get_all_staff, get_user_by_username
from auth import login

def create_cli_requirement():
    """å‰µå»º CLI å·¥å…·é–‹ç™¼éœ€æ±‚å–®"""
    
    # å»ºç«‹è³‡æ–™åº«é€£æ¥
    conn = create_connection()
    if not conn:
        print("âŒ ç„¡æ³•é€£æ¥åˆ°è³‡æ–™åº«")
        return False
    
    try:
        # ç²å–ç®¡ç†å“¡ç”¨æˆ¶ï¼ˆnicholasï¼‰
        admin_user = get_user_by_username(conn, "nicholas")
        if not admin_user:
            print("âŒ æ‰¾ä¸åˆ°ç®¡ç†å“¡ç”¨æˆ¶ 'nicholas'")
            return False
        
        admin_id = admin_user[0]  # ç”¨æˆ¶ID
        print(f"âœ… æ‰¾åˆ°ç®¡ç†å“¡ç”¨æˆ¶: {admin_user[3]} (ID: {admin_id})")
        
        # ç²å–æ‰€æœ‰å“¡å·¥
        staff_list = get_all_staff(conn)
        if not staff_list:
            print("âŒ æ‰¾ä¸åˆ°ä»»ä½•å“¡å·¥ç”¨æˆ¶")
            return False
        
        print(f"âœ… æ‰¾åˆ° {len(staff_list)} å€‹å“¡å·¥ç”¨æˆ¶:")
        for staff in staff_list:
            print(f"   - {staff[1]} (ID: {staff[0]})")
        
        # é¸æ“‡æŒ‡æ´¾å°è±¡ï¼ˆé€™è£¡é¸æ“‡ç¬¬ä¸€å€‹å“¡å·¥ï¼Œæ‚¨å¯ä»¥ä¿®æ”¹ï¼‰
        assignee_id = staff_list[0][0]
        assignee_name = staff_list[0][1]
        print(f"ğŸ“‹ å°‡éœ€æ±‚å–®æŒ‡æ´¾çµ¦: {assignee_name} (ID: {assignee_id})")
        
        # éœ€æ±‚å–®è©³ç´°å…§å®¹
        title = "é–‹ç™¼éœ€æ±‚ç®¡ç†ç³»çµ± CLI å·¥å…·"
        
        description = """
## éœ€æ±‚æ¦‚è¿°
é–‹ç™¼ä¸€å€‹åŠŸèƒ½å®Œæ•´çš„å‘½ä»¤è¡Œç•Œé¢ï¼ˆCLIï¼‰å·¥å…·ï¼Œç‚ºç¾æœ‰çš„éœ€æ±‚ç®¡ç†ç³»çµ±æä¾›å‘½ä»¤è¡Œæ“ä½œèƒ½åŠ›ã€‚

## ä¸»è¦åŠŸèƒ½éœ€æ±‚

### 1. èªè­‰åŠŸèƒ½ (auth)
- ç™»å…¥åŠŸèƒ½ï¼šæ”¯æŒç”¨æˆ¶åå¯†ç¢¼ç™»å…¥
- æœƒè©±ç®¡ç†ï¼šæ”¯æŒæœƒè©±ä¿å­˜å’Œè‡ªå‹•ç™»å…¥
- ç™»å‡ºåŠŸèƒ½ï¼šæ¸…ç†æœƒè©±ä¿¡æ¯
- èº«ä»½æŸ¥è©¢ï¼šæŸ¥çœ‹ç•¶å‰ç™»å…¥ç”¨æˆ¶ä¿¡æ¯

### 2. ç”¨æˆ¶ç®¡ç†åŠŸèƒ½ (user)
- ç”¨æˆ¶åˆ—è¡¨ï¼šé¡¯ç¤ºæ‰€æœ‰ç”¨æˆ¶æˆ–æŒ‰è§’è‰²ç¯©é¸
- ç”¨æˆ¶å‰µå»ºï¼šå‰µå»ºæ–°ç”¨æˆ¶å¸³è™Ÿ
- ç”¨æˆ¶æŸ¥è©¢ï¼šæŸ¥çœ‹ç‰¹å®šç”¨æˆ¶è©³ç´°ä¿¡æ¯
- ç”¨æˆ¶æ›´æ–°ï¼šä¿®æ”¹ç”¨æˆ¶ä¿¡æ¯

### 3. éœ€æ±‚å–®ç®¡ç†åŠŸèƒ½ (requirement)
- å‰µå»ºéœ€æ±‚å–®ï¼šæ”¯æŒç«‹å³ç™¼æ´¾å’Œé ç´„ç™¼æ´¾
- éœ€æ±‚å–®åˆ—è¡¨ï¼šæ”¯æŒå¤šç¨®ç¯©é¸æ¢ä»¶
- éœ€æ±‚å–®è©³æƒ…ï¼šæŸ¥çœ‹éœ€æ±‚å–®å®Œæ•´ä¿¡æ¯
- æäº¤éœ€æ±‚å–®ï¼šå“¡å·¥æäº¤å®Œæˆæƒ…æ³
- å¯©æ ¸éœ€æ±‚å–®ï¼šç®¡ç†å“¡å¯©æ ¸åŠŸèƒ½

### 4. ç®¡ç†å“¡åŠŸèƒ½ (admin)
- ç³»çµ±çµ±è¨ˆï¼šæŸ¥çœ‹ç³»çµ±ä½¿ç”¨çµ±è¨ˆ
- é ç´„ç®¡ç†ï¼šç®¡ç†é ç´„ç™¼æ´¾çš„éœ€æ±‚å–®
- åƒåœ¾æ¡¶ç®¡ç†ï¼šç®¡ç†å·²åˆªé™¤çš„éœ€æ±‚å–®
- æ•¸æ“šåº«ç¶­è­·ï¼šå‚™ä»½ã€æ¢å¾©ç­‰ç¶­è­·åŠŸèƒ½

### 5. æ‰¹é‡æ“ä½œåŠŸèƒ½
- æ‰¹é‡å‰µå»ºï¼šå¾ CSV æ–‡ä»¶æ‰¹é‡å‰µå»ºéœ€æ±‚å–®
- æ‰¹é‡æ›´æ–°ï¼šæ‰¹é‡æ›´æ–°éœ€æ±‚å–®ç‹€æ…‹
- æ¨¡æ¿æ”¯æŒï¼šæ”¯æŒå¾æ¨¡æ¿å‰µå»ºéœ€æ±‚å–®

## æŠ€è¡“éœ€æ±‚

### é–‹ç™¼ç’°å¢ƒ
- ç¨‹å¼èªè¨€ï¼šPython 3.8+
- CLI æ¡†æ¶ï¼šClick æˆ– argparse
- æ•¸æ“šåº«ï¼šé‡ç”¨ç¾æœ‰ SQLite æ•¸æ“šåº«
- é…ç½®ç®¡ç†ï¼šYAML æ ¼å¼é…ç½®æ–‡ä»¶
- æ—¥èªŒç³»çµ±ï¼šæ¨™æº– Python logging

### æ¶æ§‹è¦æ±‚
- æ¨¡å¡ŠåŒ–è¨­è¨ˆï¼šæŒ‰åŠŸèƒ½åˆ†é›¢å‘½ä»¤æ¨¡çµ„
- å¯æ“´å±•æ€§ï¼šæ”¯æŒæ’ä»¶ç³»çµ±
- éŒ¯èª¤è™•ç†ï¼šå®Œå–„çš„éŒ¯èª¤è™•ç†å’Œç”¨æˆ¶å‹å¥½çš„éŒ¯èª¤ä¿¡æ¯
- è¼¸å‡ºæ ¼å¼ï¼šæ”¯æŒè¡¨æ ¼ã€JSONã€CSV å¤šç¨®è¼¸å‡ºæ ¼å¼

### æ€§èƒ½è¦æ±‚
- éŸ¿æ‡‰æ™‚é–“ï¼šå–®å€‹å‘½ä»¤åŸ·è¡Œæ™‚é–“ < 2ç§’
- æ‰¹é‡è™•ç†ï¼šæ”¯æŒè™•ç† 1000+ æ¢è¨˜éŒ„
- å…§å­˜ä½¿ç”¨ï¼šæ­£å¸¸æ“ä½œå…§å­˜ä½¿ç”¨ < 100MB

## å¯¦æ–½è¨ˆåŠƒ

### ç¬¬ä¸€éšæ®µ (é€± 1-2): åŸºç¤æ¶æ§‹
- è¨­ç½®é …ç›®çµæ§‹å’Œé–‹ç™¼ç’°å¢ƒ
- å¯¦ç¾ CLI æ¡†æ¶å’ŒåŸºæœ¬å‘½ä»¤çµæ§‹
- å¯¦ç¾èªè­‰åŠŸèƒ½ (login, logout, whoami)
- å¯¦ç¾åŸºæœ¬çš„è¼¸å‡ºæ ¼å¼åŒ– (table, json)
- ç·¨å¯«åŸºç¤æ¸¬è©¦ç”¨ä¾‹

### ç¬¬äºŒéšæ®µ (é€± 3-4): æ ¸å¿ƒåŠŸèƒ½
- å¯¦ç¾éœ€æ±‚å–®ç®¡ç†åŠŸèƒ½ (create, list, show)
- å¯¦ç¾ç”¨æˆ¶ç®¡ç†åŠŸèƒ½ (list, create, show)
- å¯¦ç¾éœ€æ±‚å–®æäº¤å’Œå¯©æ ¸åŠŸèƒ½
- æ·»åŠ é…ç½®æ–‡ä»¶æ”¯æŒ
- å¯¦ç¾æœƒè©±ç®¡ç†

### ç¬¬ä¸‰éšæ®µ (é€± 5): ç®¡ç†å“¡åŠŸèƒ½
- å¯¦ç¾ç®¡ç†å“¡çµ±è¨ˆåŠŸèƒ½
- å¯¦ç¾é ç´„ç™¼æ´¾ç®¡ç†
- å¯¦ç¾åƒåœ¾æ¡¶ç®¡ç†
- å¯¦ç¾æ•¸æ“šåº«ç¶­è­·åŠŸèƒ½
- æ·»åŠ  CSV è¼¸å‡ºæ ¼å¼

### ç¬¬å››éšæ®µ (é€± 6): å®Œå–„å’Œæ¸¬è©¦
- å¯¦ç¾æ‰¹é‡æ“ä½œåŠŸèƒ½
- å®Œå–„éŒ¯èª¤è™•ç†å’Œç”¨æˆ¶é«”é©—
- ç·¨å¯«å®Œæ•´çš„æ¸¬è©¦å¥—ä»¶
- ç·¨å¯«ç”¨æˆ¶æ–‡æª”å’Œéƒ¨ç½²æŒ‡å—
- æ€§èƒ½å„ªåŒ–å’Œæœ€çµ‚æ¸¬è©¦

## é©—æ”¶æ¨™æº–

### åŠŸèƒ½é©—æ”¶
- æ‰€æœ‰å‘½ä»¤åŠŸèƒ½æ­£å¸¸é‹è¡Œ
- è¼¸å‡ºæ ¼å¼æ­£ç¢ºä¸”ä¸€è‡´
- éŒ¯èª¤è™•ç†é©ç•¶ä¸”ç”¨æˆ¶å‹å¥½
- æ¬Šé™æ§åˆ¶æ­£ç¢ºå¯¦æ–½
- æ‰¹é‡æ“ä½œåŠŸèƒ½æ­£å¸¸

### æ€§èƒ½é©—æ”¶
- å–®å€‹å‘½ä»¤éŸ¿æ‡‰æ™‚é–“ < 2ç§’
- æ‰¹é‡è™•ç† 1000 æ¢è¨˜éŒ„ < 30ç§’
- å…§å­˜ä½¿ç”¨åœ¨åˆç†ç¯„åœå…§

### è³ªé‡é©—æ”¶
- ä»£ç¢¼é€šéæ‰€æœ‰æ¸¬è©¦ç”¨ä¾‹
- æ¸¬è©¦è¦†è“‹ç‡ > 80%
- ä»£ç¢¼ç¬¦åˆ PEP 8 è¦ç¯„
- æ–‡æª”å®Œæ•´ä¸”æº–ç¢º

## äº¤ä»˜ç‰©
- å®Œæ•´çš„ CLI å·¥å…·æºä»£ç¢¼
- å–®å…ƒæ¸¬è©¦å’Œé›†æˆæ¸¬è©¦
- ç”¨æˆ¶ä½¿ç”¨æ‰‹å†Š
- é–‹ç™¼è€…æ–‡æª”
- éƒ¨ç½²æŒ‡å—

## é è¨ˆå®Œæˆæ™‚é–“
4-6é€±

## å‚™è¨»
æ­¤éœ€æ±‚å–®ç·¨è™Ÿï¼šREQ-CLI-001
å„ªå…ˆç´šï¼šé«˜
åƒè€ƒæ–‡æª”ï¼šCLI_DESIGN.md, CLI_REQUIREMENT.md
        """.strip()
        
        # è¨­å®šå„ªå…ˆç´šç‚ºç·Šæ€¥ï¼ˆå› ç‚ºæ˜¯é‡è¦çš„ç³»çµ±æ“´å±•ï¼‰
        priority = "urgent"
        
        # è¨­å®šé ç´„ç™¼æ´¾æ™‚é–“ï¼ˆå¯é¸ï¼Œé€™è£¡è¨­ç‚ºç«‹å³ç™¼æ´¾ï¼‰
        scheduled_time = None  # None è¡¨ç¤ºç«‹å³ç™¼æ´¾
        
        # å‰µå»ºéœ€æ±‚å–®
        req_id = create_requirement(
            conn=conn,
            title=title,
            description=description,
            assigner_id=admin_id,
            assignee_id=assignee_id,
            priority=priority,
            scheduled_time=scheduled_time
        )
        
        if req_id:
            print(f"âœ… æˆåŠŸå‰µå»ºéœ€æ±‚å–®ï¼")
            print(f"   éœ€æ±‚å–®ID: {req_id}")
            print(f"   æ¨™é¡Œ: {title}")
            print(f"   æŒ‡æ´¾è€…: {admin_user[3]} (ID: {admin_id})")
            print(f"   æ¥æ”¶è€…: {assignee_name} (ID: {assignee_id})")
            print(f"   å„ªå…ˆç´š: {'ç·Šæ€¥' if priority == 'urgent' else 'æ™®é€š'}")
            print(f"   ç‹€æ…‹: å·²ç™¼æ´¾")
            print(f"   å‰µå»ºæ™‚é–“: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
            return True
        else:
            print("âŒ å‰µå»ºéœ€æ±‚å–®å¤±æ•—")
            return False
            
    except Exception as e:
        print(f"âŒ å‰µå»ºéœ€æ±‚å–®æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
        return False
    finally:
        conn.close()

def main():
    """ä¸»å‡½æ•¸"""
    print("ğŸš€ é–‹å§‹å‰µå»º CLI å·¥å…·é–‹ç™¼éœ€æ±‚å–®...")
    print("=" * 50)
    
    # æª¢æŸ¥è³‡æ–™åº«æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if not os.path.exists("users.db"):
        print("âŒ æ‰¾ä¸åˆ°è³‡æ–™åº«æ–‡ä»¶ 'users.db'")
        print("   è«‹ç¢ºä¿æ‚¨åœ¨æ­£ç¢ºçš„å°ˆæ¡ˆç›®éŒ„ä¸­é‹è¡Œæ­¤è…³æœ¬")
        return
    
    # å‰µå»ºéœ€æ±‚å–®
    success = create_cli_requirement()
    
    print("=" * 50)
    if success:
        print("ğŸ‰ CLI å·¥å…·é–‹ç™¼éœ€æ±‚å–®å‰µå»ºæˆåŠŸï¼")
        print("\nğŸ“ æ‚¨ç¾åœ¨å¯ä»¥ï¼š")
        print("1. é‹è¡Œ main.py å•Ÿå‹•éœ€æ±‚ç®¡ç†ç³»çµ±")
        print("2. ä½¿ç”¨ç®¡ç†å“¡å¸³è™Ÿ (nicholas/nicholas941013) ç™»å…¥")
        print("3. æŸ¥çœ‹å·²ç™¼æ´¾çš„éœ€æ±‚å–®")
        print("4. æˆ–ä½¿ç”¨å“¡å·¥å¸³è™ŸæŸ¥çœ‹æ”¶åˆ°çš„éœ€æ±‚å–®")
        print("\nğŸ’¡ æç¤ºï¼š")
        print("- éœ€æ±‚å–®å·²è¨­ç‚ºç·Šæ€¥å„ªå…ˆç´š")
        print("- è©³ç´°çš„é–‹ç™¼è¦æ ¼è«‹åƒè€ƒ CLI_DESIGN.md å’Œ CLI_REQUIREMENT.md")
        print("- å¯ä»¥æ ¹æ“šå¯¦éš›æƒ…æ³èª¿æ•´éœ€æ±‚å–®å…§å®¹å’ŒæŒ‡æ´¾å°è±¡")
    else:
        print("âŒ éœ€æ±‚å–®å‰µå»ºå¤±æ•—")
        print("è«‹æª¢æŸ¥éŒ¯èª¤ä¿¡æ¯ä¸¦é‡è©¦")

if __name__ == "__main__":
    main() 