#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
CLI åŠŸèƒ½å¯¦ç¾éœ€æ±‚å–®å‰µå»ºè…³æœ¬

æ­¤è…³æœ¬å°‡å‰µå»ºä¸€å€‹ç”¨æ–¼å¯¦ç¾ CLI å·¥å…·æ ¸å¿ƒåŠŸèƒ½çš„éœ€æ±‚å–®ã€‚
"""

import sys
import os
from datetime import datetime, timedelta

# æ·»åŠ ç•¶å‰ç›®éŒ„åˆ° Python è·¯å¾‘
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from database import create_connection, create_requirement, get_all_staff, get_user_by_username

def create_cli_implementation_requirement():
    """å‰µå»º CLI åŠŸèƒ½å¯¦ç¾éœ€æ±‚å–®"""
    
    # å»ºç«‹è³‡æ–™åº«é€£æ¥
    conn = create_connection()
    if not conn:
        print("âŒ ç„¡æ³•é€£æ¥åˆ°è³‡æ–™åº«")
        return False
    
    try:
        # ç²å–ç®¡ç†å“¡ç”¨æˆ¶ï¼ˆnicholasï¼‰
        admin_user = get_user_by_username(conn, "nicholas")
        if not admin_user:
            print("âŒ æ‰¾ä¸åˆ°ç®¡ç†å“¡ç”¨æˆ¶ 'nicholas'")
            return False
        
        admin_id = admin_user[0]
        print(f"âœ… æ‰¾åˆ°ç®¡ç†å“¡ç”¨æˆ¶: {admin_user[3]} (ID: {admin_id})")
        
        # ç²å–æ‰€æœ‰å“¡å·¥
        staff_list = get_all_staff(conn)
        if not staff_list:
            print("âŒ æ‰¾ä¸åˆ°ä»»ä½•å“¡å·¥ç”¨æˆ¶")
            return False
        
        print(f"âœ… æ‰¾åˆ° {len(staff_list)} å€‹å“¡å·¥ç”¨æˆ¶")
        
        # é¸æ“‡æŒ‡æ´¾å°è±¡ï¼ˆé¸æ“‡ç¬¬ä¸€å€‹å“¡å·¥ï¼‰
        assignee_id = staff_list[0][0]
        assignee_name = staff_list[0][1]
        print(f"ğŸ“‹ å°‡éœ€æ±‚å–®æŒ‡æ´¾çµ¦: {assignee_name} (ID: {assignee_id})")
        
        # éœ€æ±‚å–®è©³ç´°å…§å®¹
        title = "å¯¦ç¾ CLI å·¥å…·æ ¸å¿ƒåŠŸèƒ½"
        
        description = """
## éœ€æ±‚æ¦‚è¿°
æ ¹æ“šéœ€æ±‚å–® REQ-CLI-001 çš„è¦åŠƒï¼Œå¯¦ç¾ CLI å·¥å…·çš„æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…æ‹¬èªè­‰ã€ç”¨æˆ¶ç®¡ç†ã€éœ€æ±‚å–®ç®¡ç†ç­‰æ¨¡çµ„ã€‚

## ä¸»è¦ä»»å‹™

### 1. å®Œå–„èªè­‰åŠŸèƒ½ (auth) ğŸ”
- ä¿®å¾© auth.py ä¸­çš„æ¨¡çµ„å°å…¥å•é¡Œ
- å¯¦ç¾èˆ‡ç¾æœ‰è³‡æ–™åº«çš„æ•´åˆ
- å®Œå–„ç™»å…¥/ç™»å‡º/æœƒè©±æŸ¥è©¢åŠŸèƒ½
- æ¸¬è©¦èªè­‰æµç¨‹çš„å®Œæ•´æ€§

**é©—æ”¶æ¨™æº–:**
- èƒ½å¤ æˆåŠŸç™»å…¥ç®¡ç†å“¡å’Œå“¡å·¥å¸³è™Ÿ
- æœƒè©±ç®¡ç†æ­£å¸¸é‹ä½œ
- éŒ¯èª¤è™•ç†é©ç•¶

**æ¸¬è©¦å‘½ä»¤:**
```bash
python reqmgr.py auth login -u nicholas -p nicholas941013 --save-session
python reqmgr.py auth whoami
python reqmgr.py auth logout
```

### 2. å¯¦ç¾ç”¨æˆ¶ç®¡ç†åŠŸèƒ½ (user) ğŸ‘¥
- å¯¦ç¾ç”¨æˆ¶åˆ—è¡¨æŸ¥è©¢åŠŸèƒ½
- å¯¦ç¾ç”¨æˆ¶å‰µå»ºåŠŸèƒ½
- å¯¦ç¾ç”¨æˆ¶è©³æƒ…æŸ¥çœ‹åŠŸèƒ½
- æ”¯æŒå¤šç¨®è¼¸å‡ºæ ¼å¼ (table/json/csv)

**åŠŸèƒ½éœ€æ±‚:**
- `user list`: åˆ—å‡ºæ‰€æœ‰ç”¨æˆ¶ï¼Œæ”¯æŒè§’è‰²ç¯©é¸
- `user create`: å‰µå»ºæ–°ç”¨æˆ¶ï¼ŒåŒ…å«å®Œæ•´çš„åƒæ•¸é©—è­‰
- `user show <id>`: é¡¯ç¤ºç‰¹å®šç”¨æˆ¶çš„è©³ç´°ä¿¡æ¯
- `user update <id>`: æ›´æ–°ç”¨æˆ¶ä¿¡æ¯ï¼ˆå¯é¸ï¼‰

**é©—æ”¶æ¨™æº–:**
- èƒ½å¤ æ­£ç¢ºé¡¯ç¤ºç”¨æˆ¶åˆ—è¡¨
- èƒ½å¤ å‰µå»ºæ–°ç”¨æˆ¶ä¸¦é©—è­‰
- è¼¸å‡ºæ ¼å¼æ­£ç¢ºä¸”ç¾è§€

**æ¸¬è©¦å‘½ä»¤:**
```bash
python reqmgr.py user list
python reqmgr.py --format json user list
python reqmgr.py user create -u testuser -p password123 -n "æ¸¬è©¦ç”¨æˆ¶" -e test@example.com
python reqmgr.py user show 1
```

### 3. å¯¦ç¾éœ€æ±‚å–®ç®¡ç†åŠŸèƒ½ (requirement) ğŸ“‹
- å¯¦ç¾éœ€æ±‚å–®åˆ—è¡¨æŸ¥è©¢åŠŸèƒ½
- å¯¦ç¾éœ€æ±‚å–®å‰µå»ºåŠŸèƒ½
- å¯¦ç¾éœ€æ±‚å–®è©³æƒ…æŸ¥çœ‹åŠŸèƒ½
- å¯¦ç¾éœ€æ±‚å–®ç‹€æ…‹æ›´æ–°åŠŸèƒ½

**åŠŸèƒ½éœ€æ±‚:**
- `requirement list`: åˆ—å‡ºéœ€æ±‚å–®ï¼Œæ”¯æŒç‹€æ…‹ç¯©é¸
- `requirement create`: å‰µå»ºæ–°éœ€æ±‚å–®
- `requirement show <id>`: é¡¯ç¤ºéœ€æ±‚å–®è©³æƒ…
- `requirement submit <id>`: æäº¤éœ€æ±‚å–®ï¼ˆå“¡å·¥åŠŸèƒ½ï¼‰
- `requirement approve <id>`: å¯©æ ¸éœ€æ±‚å–®ï¼ˆç®¡ç†å“¡åŠŸèƒ½ï¼‰

**é©—æ”¶æ¨™æº–:**
- èƒ½å¤ æ­£ç¢ºé¡¯ç¤ºéœ€æ±‚å–®åˆ—è¡¨
- èƒ½å¤ å‰µå»ºæ–°éœ€æ±‚å–®
- ç‹€æ…‹æ›´æ–°åŠŸèƒ½æ­£å¸¸
- æ¬Šé™æ§åˆ¶æ­£ç¢º

**æ¸¬è©¦å‘½ä»¤:**
```bash
python reqmgr.py requirement list
python reqmgr.py requirement create -t "æ¸¬è©¦éœ€æ±‚" -d "é€™æ˜¯ä¸€å€‹æ¸¬è©¦éœ€æ±‚å–®" -a user1
python reqmgr.py requirement show 1
python reqmgr.py requirement submit 1 -m "å·²å®Œæˆæ¸¬è©¦"
```

### 4. å¯¦ç¾ç®¡ç†å“¡åŠŸèƒ½ (admin) ğŸ‘‘
- å¯¦ç¾ç³»çµ±çµ±è¨ˆåŠŸèƒ½
- å¯¦ç¾è³‡æ–™åº«å‚™ä»½åŠŸèƒ½
- å¯¦ç¾é ç´„ç™¼æ´¾ç®¡ç†
- å¯¦ç¾åƒåœ¾æ¡¶ç®¡ç†

**åŠŸèƒ½éœ€æ±‚:**
- `admin stats`: é¡¯ç¤ºç³»çµ±çµ±è¨ˆä¿¡æ¯
- `admin backup`: å‚™ä»½è³‡æ–™åº«
- `admin scheduled`: ç®¡ç†é ç´„ç™¼æ´¾
- `admin trash`: ç®¡ç†å·²åˆªé™¤çš„éœ€æ±‚å–®

**é©—æ”¶æ¨™æº–:**
- çµ±è¨ˆä¿¡æ¯æº–ç¢ºä¸”å®Œæ•´
- å‚™ä»½åŠŸèƒ½æ­£å¸¸é‹ä½œ
- ç®¡ç†å“¡æ¬Šé™æ§åˆ¶æ­£ç¢º

**æ¸¬è©¦å‘½ä»¤:**
```bash
python reqmgr.py admin stats
python reqmgr.py admin backup
python reqmgr.py admin scheduled list
python reqmgr.py admin trash list
```

## æŠ€è¡“è¦æ±‚

### ä»£ç¢¼è³ªé‡
- éµå¾ª PEP 8 ä»£ç¢¼è¦ç¯„
- æ·»åŠ é©ç•¶çš„éŒ¯èª¤è™•ç†
- æä¾›æ¸…æ™°çš„ç”¨æˆ¶åé¥‹
- æ”¯æŒè©³ç´°æ¨¡å¼ (--verbose) è¼¸å‡º

### æ•´åˆè¦æ±‚
- èˆ‡ç¾æœ‰è³‡æ–™åº«æ¨¡çµ„å®Œå…¨æ•´åˆ
- é‡ç”¨ç¾æœ‰çš„æ¥­å‹™é‚è¼¯
- ä¿æŒèˆ‡ GUI ç‰ˆæœ¬çš„åŠŸèƒ½ä¸€è‡´æ€§
- æ”¯æŒæ‰€æœ‰ç¾æœ‰çš„è³‡æ–™åº«æ“ä½œ

### ç”¨æˆ¶é«”é©—
- æä¾›æ¸…æ™°çš„å¹«åŠ©ä¿¡æ¯
- éŒ¯èª¤è¨Šæ¯å‹å¥½ä¸”å…·é«”
- æ”¯æŒå¤šç¨®è¼¸å‡ºæ ¼å¼
- å‘½ä»¤åŸ·è¡Œé€Ÿåº¦å¿« (< 2ç§’)

## å¯¦æ–½è¨ˆåŠƒ

### ç¬¬ä¸€æ­¥: ä¿®å¾©èªè­‰åŠŸèƒ½ (1-2å¤©)
- ä¿®å¾©æ¨¡çµ„å°å…¥å•é¡Œ
- å¯¦ç¾è³‡æ–™åº«æ•´åˆ
- æ¸¬è©¦èªè­‰æµç¨‹

### ç¬¬äºŒæ­¥: å¯¦ç¾ç”¨æˆ¶ç®¡ç† (2-3å¤©)
- å¯¦ç¾ user list åŠŸèƒ½
- å¯¦ç¾ user create åŠŸèƒ½
- å¯¦ç¾ user show åŠŸèƒ½
- æ·»åŠ è¼¸å‡ºæ ¼å¼æ”¯æŒ

### ç¬¬ä¸‰æ­¥: å¯¦ç¾éœ€æ±‚å–®ç®¡ç† (3-4å¤©)
- å¯¦ç¾ requirement list åŠŸèƒ½
- å¯¦ç¾ requirement create åŠŸèƒ½
- å¯¦ç¾ requirement show åŠŸèƒ½
- å¯¦ç¾ç‹€æ…‹æ›´æ–°åŠŸèƒ½

### ç¬¬å››æ­¥: å¯¦ç¾ç®¡ç†å“¡åŠŸèƒ½ (2-3å¤©)
- å¯¦ç¾çµ±è¨ˆåŠŸèƒ½
- å¯¦ç¾å‚™ä»½åŠŸèƒ½
- å¯¦ç¾é ç´„ç®¡ç†
- å¯¦ç¾åƒåœ¾æ¡¶ç®¡ç†

### ç¬¬äº”æ­¥: æ¸¬è©¦å’Œå„ªåŒ– (1-2å¤©)
- å®Œæ•´åŠŸèƒ½æ¸¬è©¦
- æ€§èƒ½å„ªåŒ–
- æ–‡æª”æ›´æ–°
- éŒ¯èª¤è™•ç†å®Œå–„

## äº¤ä»˜ç‰©
- å®Œæ•´å¯¦ç¾çš„ CLI å·¥å…·
- æ›´æ–°çš„æ¸¬è©¦ç”¨ä¾‹
- æ›´æ–°çš„ä½¿ç”¨æ–‡æª”
- åŠŸèƒ½æ¼”ç¤ºè¦–é »ï¼ˆå¯é¸ï¼‰

## é©—æ”¶æ¨™æº–
- æ‰€æœ‰å‘½ä»¤åŠŸèƒ½æ­£å¸¸é‹è¡Œ
- èˆ‡ç¾æœ‰ç³»çµ±å®Œå…¨æ•´åˆ
- è¼¸å‡ºæ ¼å¼æ­£ç¢ºä¸”ä¸€è‡´
- éŒ¯èª¤è™•ç†é©ç•¶
- æ€§èƒ½ç¬¦åˆè¦æ±‚
- æ–‡æª”å®Œæ•´ä¸”æº–ç¢º

## å„ªå…ˆç´š
é«˜ - é€™æ˜¯ CLI å·¥å…·çš„æ ¸å¿ƒåŠŸèƒ½å¯¦ç¾

## é è¨ˆå®Œæˆæ™‚é–“
7-10 å€‹å·¥ä½œå¤©

## å‚™è¨»
- æ­¤éœ€æ±‚å–®æ˜¯ REQ-CLI-001 çš„å…·é«”å¯¦æ–½éšæ®µ
- éœ€è¦èˆ‡ç¾æœ‰çš„ GUI ç³»çµ±ä¿æŒåŠŸèƒ½ä¸€è‡´æ€§
- å¯¦ç¾éç¨‹ä¸­å¦‚é‡åˆ°æŠ€è¡“å•é¡Œï¼ŒåŠæ™‚æºé€šè§£æ±º
- å®Œæˆå¾Œéœ€è¦é€²è¡Œå®Œæ•´çš„åŠŸèƒ½æ¸¬è©¦
        """.strip()
        
        # è¨­å®šå„ªå…ˆç´šç‚ºç·Šæ€¥
        priority = "urgent"
        
        # å‰µå»ºéœ€æ±‚å–®
        req_id = create_requirement(
            conn=conn,
            title=title,
            description=description,
            assigner_id=admin_id,
            assignee_id=assignee_id,
            priority=priority,
            scheduled_time=None
        )
        
        if req_id:
            print(f"âœ… æˆåŠŸå‰µå»º CLI åŠŸèƒ½å¯¦ç¾éœ€æ±‚å–®ï¼")
            print(f"   éœ€æ±‚å–®ID: {req_id}")
            print(f"   æ¨™é¡Œ: {title}")
            print(f"   æŒ‡æ´¾è€…: {admin_user[3]} (ID: {admin_id})")
            print(f"   æ¥æ”¶è€…: {assignee_name} (ID: {assignee_id})")
            print(f"   å„ªå…ˆç´š: ç·Šæ€¥")
            print(f"   ç‹€æ…‹: å·²ç™¼æ´¾")
            print(f"   å‰µå»ºæ™‚é–“: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
            return req_id
        else:
            print("âŒ å‰µå»ºéœ€æ±‚å–®å¤±æ•—")
            return False
            
    except Exception as e:
        print(f"âŒ å‰µå»ºéœ€æ±‚å–®æ™‚ç™¼ç”ŸéŒ¯èª¤: {e}")
        return False
    finally:
        conn.close()

def main():
    """ä¸»å‡½æ•¸"""
    print("ğŸš€ é–‹å§‹å‰µå»º CLI åŠŸèƒ½å¯¦ç¾éœ€æ±‚å–®...")
    print("=" * 60)
    
    # æª¢æŸ¥è³‡æ–™åº«æ–‡ä»¶æ˜¯å¦å­˜åœ¨
    if not os.path.exists("users.db"):
        print("âŒ æ‰¾ä¸åˆ°è³‡æ–™åº«æ–‡ä»¶ 'users.db'")
        print("   è«‹ç¢ºä¿æ‚¨åœ¨æ­£ç¢ºçš„å°ˆæ¡ˆç›®éŒ„ä¸­é‹è¡Œæ­¤è…³æœ¬")
        return
    
    # å‰µå»ºéœ€æ±‚å–®
    req_id = create_cli_implementation_requirement()
    
    print("=" * 60)
    if req_id:
        print("ğŸ‰ CLI åŠŸèƒ½å¯¦ç¾éœ€æ±‚å–®å‰µå»ºæˆåŠŸï¼")
        print(f"\nğŸ“‹ éœ€æ±‚å–®ç·¨è™Ÿ: REQ-CLI-IMPL-{req_id:03d}")
        print("\nğŸ“ æ¥ä¸‹ä¾†çš„å·¥ä½œ:")
        print("1. ä¿®å¾©èªè­‰åŠŸèƒ½")
        print("2. å¯¦ç¾ç”¨æˆ¶ç®¡ç†åŠŸèƒ½")
        print("3. å¯¦ç¾éœ€æ±‚å–®ç®¡ç†åŠŸèƒ½")
        print("4. å¯¦ç¾ç®¡ç†å“¡åŠŸèƒ½")
        print("5. æ¸¬è©¦å’Œå„ªåŒ–")
        print("\nğŸ’¡ æç¤ºï¼š")
        print("- éœ€æ±‚å–®å·²è¨­ç‚ºç·Šæ€¥å„ªå…ˆç´š")
        print("- é è¨ˆå®Œæˆæ™‚é–“ï¼š7-10 å€‹å·¥ä½œå¤©")
        print("- è«‹æŒ‰ç…§å¯¦æ–½è¨ˆåŠƒé€æ­¥å®Œæˆ")
    else:
        print("âŒ éœ€æ±‚å–®å‰µå»ºå¤±æ•—")

if __name__ == "__main__":
    main() 